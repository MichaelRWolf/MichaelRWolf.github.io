#!/bin/bash


function warn() { echo "${@}" >&2; }


function date_from_filename () {
    local f="${1}"
    echo "${f}" | 
	perl -n -e 's/^(\d{4}-\d{2}-\d{2})/$1/ && print $1'
}


function date_from_front_matter() {
    local file="${1}"
    cat "${file}" |
	perl -n -e '$front_matter .= $_ if /---/.../---/; END { print $1 if $front_matter =~ /date:\s+([0-9-]+)/;}'
}


function main () {
    POSTS_DIR="_posts"
    inconsistent=false

    for file in "${POSTS_DIR}"/*.md; do
      filename=$(basename "$file" .md)

      date_from_filename=$( date_from_filename "$filename" )
      date_from_front_matter=$( date_from_front_matter "${file}" )

      if [[ "${date_from_filename}" = '' ]] || [[ "${date_from_filename}" != "${date_from_front_matter}" ]]; then
	warn "Inconsist or missing date info: ${file}"
	warn "  Date From Filename:     '${date_from_filename}'"
	warn "  Date From Front Matter: '${date_from_front_matter}'"
	inconsistent=true
      else
	  # warn "Consistent|${file}|${filename}|${date_from_filename}|${date_from_front_matter}|"
	  :
      fi
    done

    # Exit with error if inconsistencies were found
    if $inconsistent; then
      warn "Inconsistencies detected. Please correct them."
      exit 1
    else
      warn "All dates are consistent."
    fi
}

main "${@}"
