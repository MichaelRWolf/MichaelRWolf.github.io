#!/bin/bash


function date_from_filename () {
    local f="${1}"
    echo "${f}" | 
	perl -n -e 's/^(\d{4}-\d{2}-\d{2})/$1/ && print $1'
}


function date_from_front_matter() {
    local file="${1}"
    cat "$file" |
	perl -n -e '$front_matter .= $_ if /---/.../---/; END { print $1 if $front_matter =~ /date:\s+([0-9-]+)/;}'
}


function main () {
    # Directory containing posts
    POSTS_DIR="_posts"

    # Flag to track if any inconsistencies are found
    inconsistent=false

    # Iterate over each post file in the _posts directory
    for file in "$POSTS_DIR"/*.md; do
      # Extract filename without extension
      filename=$(basename "$file" .md)

      # Extract date from filename (assumes format YYYY-MM-DD-title)
      date_from_filename=$( date_from_filename "$filename" )

      # Extract date from front matter
      date_from_front_matter=$( date_from_front_matter "${file}" )

      # Compare file date with front matter date
      if [[ "$date_from_filename" = '' ]] || [[ "$date_from_filename" != "$date_from_front_matter" ]]; then
	echo "Inconsist or missing date info: $file"
	echo "  Date From Filename:     '$date_from_filename'"
	echo "  Date From Front Matter: '$date_from_front_matter'"
	inconsistent=true
      else
	  # echo "Consistent|$file|$filename|$date_from_filename|$date_from_front_matter|"
	  :
      fi
    done

    # Exit with error if inconsistencies were found
    if $inconsistent; then
      echo "Inconsistencies detected. Please correct them."
      exit 1
    else
      echo "All dates are consistent."
    fi
}

main "$@"
