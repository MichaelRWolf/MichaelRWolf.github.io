#!/bin/bash

# Directory containing posts
POSTS_DIR="_posts"

# Flag to track if any inconsistencies are found
inconsistent=false

# Iterate over each post file in the _posts directory
for file in "$POSTS_DIR"/*.md; do
  # Extract filename without extension
  filename=$(basename "$file" .md)

  # Extract date from filename (assumes format YYYY-MM-DD-title)
  file_date=$(echo "$filename" | perl -ne 's/^(\d{4}-\d{2}-\d{2})/$1/ && print $1')

  # Extract date from front matter
  frontmatter_date=$( cat "$file" | perl -n -e '$front_matter .= $_ if /---/.../---/; END { print $1 if $front_matter =~ /date:\s+([0-9-]+)/;}')

  # Compare file date with front matter date
  if [[ "$file_date" = '' ]] || [[ "$file_date" != "$frontmatter_date" ]]; then
    echo "Inconsist or missing date info: $file"
    echo "  Filename date:     '$file_date'"
    echo "  Front matter date: '$frontmatter_date'"
    inconsistent=true
  else
      # echo "Consistent|$file|$filename|$file_date|$frontmatter_date|"
      :
  fi
done

# Exit with error if inconsistencies were found
if $inconsistent; then
  echo "Inconsistencies detected. Please correct them."
  exit 1
else
  echo "All dates are consistent."
fi
